{% extends 'videopoker/base.html' %}
{% load static %}

{% block content %}

<div >
  <table class="multiplier_table">
    <colgroup>
      <col id="col_0">
      <col id="col_1">
      <col id="col_2">
      <col id="col_3">
      <col id="col_4">
      <col id="col_5">
    </colgroup>
    <tr id="tr_10">
      <td>ROYAL FLUSH</td>
      <td>250</td>
      <td>500</td>
      <td>750</td>
      <td>1000</td>
      <td>4000</td>
    </tr>
    <tr id="tr_9">
      <td>STRAIGHT FLUSH</td>
      <td>50</td>
      <td>100</td>
      <td>150</td>
      <td>200</td>
      <td>250</td>
    </tr>
    <tr id="tr_8">
      <td>FOUR OF A KIND</td>
      <td>25</td>
      <td>50</td>
      <td>75</td>
      <td>100</td>
      <td>125</td>
    </tr>
    <tr id="tr_7" >
      <td>FULL HOUSE</td>
      <td>9</td>
      <td>18</td>
      <td>27</td>
      <td>36</td>
      <td>45</td>
    </tr>
    <tr id="tr_6">
      <td>FLUSH</td>
      <td>6</td>
      <td>12</td>
      <td>18</td>
      <td>24</td>
      <td>30</td>
    </tr>
    <tr  id="tr_5" >
      <td>STRAIGHT</td>
      <td>4</td>
      <td>8</td>
      <td>12</td>
      <td>16</td>
      <td>20</td>
    </tr>
    <tr  id="tr_4">
      <td>THREE OF A KIND</td>
      <td>3</td>
      <td>6</td>
      <td>9</td>
      <td>12</td>
      <td>15</td>
    </tr>
    <tr   id="tr_3" >
      <td>TWO PAIR</td>
      <td>2</td>
      <td>4</td>
      <td>6</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr   id="tr_2">
      <td>EIGHTS OR BETTER</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>5</td>
    </tr>

  </table>
</div>
<form>
  {% csrf_token %}

  <div class="held">
    <div class="held-caption" id="held_0"><span >Held</span></div>
    <div class="held-caption" id="held_1"><span>Held</span></div>
    <div class="held-caption" id="held_2"><span>Held</span></div>
    <div class="held-caption" id="held_3"><span>Held</span></div>
    <div class="held-caption" id="held_4"><span>Held</span></div>
  </div>
  <div id="table">
  <div id='hand' class="hand">
    {% for card in drawn_cards%}
    <div class="flip-card">
      <div id="card_{{ forloop.counter0 }}" class="flip-card-inner">
        <div class="flip-card-front" onclick="hold_card(this, {{forloop.counter0}})">
        </div>
        <div class="flip-card-back">
        </div>
      </div>
    </div>
    
    {% endfor %}

    <input type="hidden" name="held" id="held" value="0">
    <input type="hidden"  id="combination" value="{{combination}}">
    <input type="hidden"  id="dealt" value="{{dealt}}">
    <input type="hidden"  id="balance" value="{{balance}}">
    
  </div>
    <div class="balance"><span>Balance: {{balance}} chips</span>

    </div>
</div>
  
  <div class="buttons">
    <button name="bet_button" id="bet_button" type="button" class="button" role="button" onclick="bet_increase()">Bet</button>
    <button type="button" id="deal_button" class="button" role="button" hx-post="/videopoker/deal/" hx-target="#table">Deal</button>
  </div>
  <input type="hidden" name="bet_m" id="bet_m" value="1">
  
  <audio id="audio" src="{% static 'videopoker/notify_win_hand.mp3' %}" ></audio>
  <audio id="audio_win" src="{% static 'videopoker/win_hand_straight_and_higher.mp3' %}" ></audio>
  <audio id="audio_win_rf" src="{% static 'videopoker/royal_flush.mp3' %}" ></audio>
</form>




<script>
  
  document.body.addEventListener('htmx:afterSettle', function (evt) {

    var elements = document.getElementsByClassName("held-caption");

        for (var i = 0; i < elements.length; i++) {
            elements[i].style='visibility:hidden';
        }

    var audio = document.getElementById("audio");
    var audio_win = document.getElementById("audio_win");
    var comb = document.getElementById("combination").value;
    var dealt = document.getElementById("dealt").value;
    var bet_button = document.getElementById("bet_button");
    var deal_button = document.getElementById("deal_button");

    deal_button.removeAttribute('DISABLED', false); // Enabling Deal button.

    if (dealt == 'True') { // Cards are just dealt and ready to be drawn.
      bet_button.setAttribute('DISABLED', true);
      deal_button.innerHTML = 'Draw';
      
    } else { // Cards are ready to be dealt again.
      bet_button.removeAttribute('DISABLED', false);
      deal_button.innerHTML = 'Deal';
    }

    if (comb > 1) {
      if (!document.getElementById("tr_" + comb).classList.contains('row_combination')) {
        if (dealt == 'True') { // Cards are just dealt and hand is winning. Notification audio is played.
          audio.pause();
          audio.currentTime = 0;
          audio.play();
        }
        else { // Final hand is presented.
          if (comb > 4) { // Winning hand audio played.
            if (comb < 10) {
              audio_win.pause();
              audio_win.currentTime = 0;
              audio_win.play();
            }

            else { // Royal flush audio is played.
              audio_win_rf.pause();
              audio_win_rf.currentTime = 0;
              audio_win_rf.play();
            }
            
          }
        }
        document.getElementById("tr_" + comb).classList.add("row_combination");
      }
    }
    
    
  });

  //Flipping cards before the draw and return to normal place after the hold animation.
  document.body.addEventListener('htmx:confirm', function (evt) {
    var deal_button = document.getElementById("deal_button");
    deal_button.setAttribute('DISABLED', true); // Disabling Deal button until the cards are dealt.

    var held_cards_value = parseInt(document.getElementById("held").value);
    const values = [16, 8, 4, 2, 1];

    for (let index = 0; index < values.length; index++) {
      if (held_cards_value >= values[index]) {
        held_cards_value = held_cards_value - values[index];
      } else {

        document.getElementById("card_" + index).classList.remove('flip-animation');
      }
      
    }

    for (let index = 2; index < 11; index++) {
      if (document.getElementById("tr_" + index).classList.contains('row_combination')) {
        document.getElementById("tr_" + index).classList.remove("row_combination");
      }
      
    }
    
  });


  // const event = new Event('htmx:afterSettle');

  // Dispatching event at initial load.
  // document.body.dispatchEvent(event);


  var bet_multiplier = 1;
  document.getElementById("col_" + bet_multiplier).classList.add('bet_selected');

  // window.onload = function () {
  //   // Your code here
  //   for (let i = 1; i <= 5; i++) {
  //     document.getElementById("card_" + i).classList.add('flip-animation');
  //   }
  // };

  function hold_card(card_clicked, id) {
    var dealt = document.getElementById("dealt").value;

    if (dealt == 'False') {
      return; // Cards are drawn already. Ready to be dealt.
    }
    var values = [16, 8, 4, 2, 1];
    var grandParent = card_clicked.parentElement.parentElement;
     if (grandParent.classList.contains("hold_animation")) {
      grandParent.classList.remove('hold_animation');
      document.getElementById("held_" + id).style='';
      document.getElementById("held").value = parseInt(document.getElementById("held").value) - values[id];
    }
    else {
      grandParent.classList.add('hold_animation');
      document.getElementById("held_" + id).style='visibility:visible';
      document.getElementById("held").value = parseInt(document.getElementById("held").value) + values[id];
    }
  }

  function bet_increase() {
    document.getElementById("col_" + bet_multiplier).classList.remove('bet_selected');
    bet_multiplier = bet_multiplier + 1;
    if (bet_multiplier > 5) {
      bet_multiplier = 1;
    }
    document.getElementById("col_" + bet_multiplier).classList.add('bet_selected');
    document.getElementById("bet_m").value = bet_multiplier;
  }

</script>
{% endblock %}